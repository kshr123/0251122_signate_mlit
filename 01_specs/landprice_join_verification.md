# 地価公示データ結合検証 仕様書

## 目的

train/testデータと地価公示データ（2024, 2025年）の結合可能性を検証する。

---

## 検証内容

### 1. 座標変換の確認

- 地価公示の座標（秒）をWGS84（度）に変換
- 変換式: `度 = 秒 / 3600`
- 変換後の座標範囲がtrain/testと整合するか確認

### 2. 最近傍探索

- BallTree（Haversine距離）を使用
- 各train/testレコードから最も近い地価公示地点を探索
- 計算量削減のためサンプリング（10,000件）で検証

### 3. 結合率・距離分布の確認

| 指標 | 説明 |
|------|------|
| 最近傍距離の分布 | 平均、中央値、最大、パーセンタイル |
| 結合率（閾値別） | 1km以内、3km以内、5km以内で結合できる割合 |
| 都道府県別の分布 | 都市部と地方の差 |

---

## 実装仕様

### 入力

| データ | ファイル | 使用カラム |
|--------|----------|------------|
| train | `data/raw/train.csv` | `lon`, `lat`, `addr1_1` |
| 地価公示2024 | `data/external/landprice/L01-2024P-48-01.0a/L01-2024P-2K.csv` | `経度`, `緯度`, `価格R06` |
| 地価公示2025 | `data/external/landprice/L01-2025P-48-01.0a/L01-2025P-2K.csv` | `経度`, `緯度`, `価格R07` |

### 処理フロー

```
1. データ読み込み
   - train: lon, lat
   - 地価公示: 経度, 緯度 → 度に変換

2. BallTree構築
   - 地価公示の座標でBallTree構築
   - metric='haversine'（地球表面の距離）

3. 最近傍探索
   - trainからサンプル10,000件抽出
   - 各サンプルの最近傍1件を探索
   - 距離（km）を計算

4. 結果集計
   - 距離の統計量
   - 閾値別結合率
   - 都道府県別分布
```

### 出力

| 出力 | 内容 |
|------|------|
| 距離統計 | mean, median, std, min, max, percentiles |
| 結合率 | 1km/3km/5km以内の割合 |
| 可視化 | 距離分布ヒストグラム |

---

## 判断基準

| 結合率 | 判断 |
|--------|------|
| 90%以上（5km以内） | ✅ 全国的に活用可能 |
| 70-90%（5km以内） | ⚠️ 都市部中心に活用 |
| 70%未満 | ❌ 別戦略を検討 |

---

## 検証結果（2025-11-26実施）

### 概要

| 項目 | 結果 |
|------|------|
| サンプル数 | 10,000件（trainから無作為抽出） |
| 地価公示 | 2025年（25,563件） |
| **結論** | ✅ **全国的に活用可能** |

### 距離統計

| 統計量 | 値 |
|--------|-----|
| 平均 | 0.47 km |
| 中央値 | 0.33 km |
| 標準偏差 | 0.68 km |
| 最小 | 0.00 km |
| 最大 | 26.52 km |

### パーセンタイル

| パーセンタイル | 距離 |
|----------------|------|
| 25%ile | 0.21 km |
| 50%ile | 0.33 km |
| 75%ile | 0.50 km |
| 90%ile | 0.81 km |
| 95%ile | 1.23 km |
| 99%ile | 3.00 km |

### 結合率（閾値別）

| 閾値 | 結合率 |
|------|--------|
| 0.5km以内 | **74.6%** |
| 1km以内 | **93.2%** |
| 2km以内 | 97.9% |
| 3km以内 | 99.0% |
| 5km以内 | **99.6%** |
| 10km以内 | 100.0% |

### 都道府県別（上位10）

| 都道府県コード | 平均距離 | 中央値 | 件数 |
|----------------|----------|--------|------|
| 13（東京） | 0.28 km | 0.26 km | 1,839 |
| 27（大阪） | 0.32 km | 0.29 km | 1,174 |
| 14（神奈川） | 0.36 km | 0.32 km | 1,138 |
| 11（埼玉） | 0.44 km | 0.36 km | 859 |
| 12（千葉） | 0.61 km | 0.37 km | 627 |
| 28（兵庫） | 0.49 km | 0.33 km | 605 |
| 23（愛知） | 0.41 km | 0.33 km | 554 |
| 40（福岡） | 0.43 km | 0.33 km | 448 |
| 26（京都） | 0.47 km | 0.30 km | 351 |
| 22（静岡） | 1.01 km | 0.56 km | 260 |

### 結論

1. **99.6%が5km以内**で結合可能 → 全国的に活用可能
2. **中央値0.33km** → ほとんどの物件で近くに地価公示地点あり
3. **都市部（東京・大阪）は0.3km以内** → 特に高精度
4. **地方（静岡等）でも1km程度** → 十分に活用可能

### 推奨閾値

| 用途 | 推奨閾値 | カバー率 |
|------|----------|----------|
| 厳密な結合 | 1km | 93.2% |
| 標準的な結合 | 3km | 99.0% |
| 全件結合 | 5km | 99.6% |

---

## 更新履歴

- 2025-11-26: 初版作成
- 2025-11-26: 検証結果を追記
