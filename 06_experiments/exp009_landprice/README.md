# exp009_landprice

## 概要

exp008をベースに、地価公示データ（2019〜2024年）を外部データとして結合し、特徴量を追加する実験。

- **ベース**: exp008_reform_features (特徴量数: 181)
- **目標**: CV MAPE改善

---

## 結合方針

### 年度マッピング

`target_ym`の年に対応する地価公示データを使用：

| データ | target_ym | 使用する地価公示 | 価格カラム |
|--------|-----------|------------------|------------|
| train | 2019年 | 2019年 | `Ｈ３１価格`（全角） |
| train | 2020年 | 2020年 | `Ｒ２価格`（全角） |
| train | 2021年 | 2021年 | `Ｒ３価格`（全角） |
| train | 2022年 | 2022年 | `Ｒ４価格`（全角） |
| **test** | **2023年** | **2024年** | `価格R06`（半角） |

> **注**: 地価公示は毎年1月1日時点の価格を3月に発表。2023年の物件には2024年公示（2024年3月発表）を使用。

### 利用可能な地価公示データ

| 年度 | ファイル | 件数 | 価格カラム |
|------|----------|------|------------|
| 2019 | L01-31P-2K.csv | 25,993 | `Ｈ３１価格` |
| 2020 | L01-2020P-2K.csv | 25,993 | `Ｒ２価格` |
| 2021 | L01-2021P-2K.csv | 25,993 | `Ｒ３価格` |
| 2022 | L01-2022P-2K.csv | 25,993 | `Ｒ４価格` |
| 2023 | L01-2023P-2K.csv | 25,993 | `Ｒ５価格` |
| 2024 | L01-2024P-2K.csv | 25,994 | `価格R06` |

### 結合方法

1. 座標ベースの最近傍探索（BallTree, Haversine距離）
2. train/testの`lon`, `lat` ↔ 地価公示の`経度`, `緯度`（秒→度変換）
3. 最大距離: 5km（超過分は欠損扱い）
4. 結合率: 99.7%（5km以内）、0.3%が欠損

### 欠損値補完

5km以上離れた物件（1,149件、0.3%）は欠損となるため、階層的に補完：

| 優先度 | 補完方法 | グループキー | 説明 |
|--------|----------|--------------|------|
| 1 | 年度×フル郵便番号平均 | `target_year` + `post1` + `post2` | 同年度・同郵便番号の平均 |
| 2 | 年度×市区町村平均 | `target_year` + `addr1_2` | 同年度・同市区町村の平均 |

> **注**: 年度を考慮することで、異なる年度のデータで補完することを防止。

---

## 追加特徴量

### 1. 土地属性（1次元）

| 入力カラム | 処理 | 出力 |
|------------|------|------|
| 間口比率 + 奥行比率 | PCA | `lp_shape_pca` (1次元) |

**除外**:
- 地積: 最近傍地点の面積（対象物件と無関係）
- 土地形状: 同上

---

### 2. 道路状況（14次元）

| 入力カラム | 型 | 処理 | 出力 |
|------------|-----|------|------|
| 前面道路区分 | カテゴリ(15) | One-hot → SVD | `lp_road_svd_0〜12` |
| 前面道路方位 | カテゴリ(9) | One-hot → SVD | ↑ |
| 側道状況 | カテゴリ(5) | One-hot → SVD | ↑ |
| 前面道路幅員 | 数値 | そのまま | `lp_road_width` |

**除外**:
- 前面道路舗装状況: 99.8%が欠損（`_`）

**SVD次元数**: 13次元（累積分散説明率 91%）

---

### 3. 周辺環境（1次元）

| 入力カラム | 型 | 処理 | 出力 |
|------------|-----|------|------|
| 利用現況 | カテゴリ(315) | ラベルエンコ（上位10+その他） | `lp_current_use_le` |

**上位10カテゴリ**（累積91.3%）:
1. 住宅 (66.9%)
2. 店舗兼住宅 (5.9%)
3. 店舗 (5.8%)
4. 店舗兼共同住宅 (2.7%)
5. 店舗兼事務所 (2.6%)
6. 事務所 (2.3%)
7. 共同住宅 (2.1%)
8. 工場 (1.8%)
9. 倉庫 (0.6%)
10. 事務所兼住宅 (0.6%)
11. **その他** (8.7%)

**次回実験に回す**:
- 周辺土地利用: Embedding処理（テキスト11,694ユニーク）

---

### 4. 都市計画

**全て除外**:
- 高度地区: 全て`_`（データなし）
- 森林法区分: 99.8%が`_`
- 防火地域: 有用だが今回は除外

---

### 5. 価格（3次元）

| 入力カラム | 処理 | 出力 |
|------------|------|------|
| 当年価格 | そのまま | `lp_price` |
| 対前年変動率 | そのまま | `lp_change_rate` |
| 最近傍距離 | BallTree計算 | `lp_nearest_dist` |

---

### 6. 価格時系列（2次元）

**スライド方式**（各期間の独立した変化を捉える）:

| 特徴量名 | 計算式 | 説明 | 充足率 |
|----------|--------|------|--------|
| `lp_ratio_1to3` | 1年前 / 3年前 | 1〜3年前の変化 | 93%+ |
| `lp_ratio_3to5` | 3年前 / 5年前 | 3〜5年前の変化 | 84%+ |

**対前年変動率との関係**:
- `対前年変動率` ≒ 直近1年の変化（`lp_change_rate`で代用）
- `lp_ratio_0to1`は作成しない（重複）

**欠損処理**: NaNのまま（LightGBMが処理）

---

### 7. カテゴリ別地価比率（18次元）

各カテゴリごとの`lp_price`平均を計算し、物件の`lp_price`との比率を特徴量化。

**計算方法**:
- train/testそれぞれ独立に平均を計算（地価公示は外部データのためリーケージなし）
- 比率 = `lp_price` / カテゴリ別平均
- 比率 > 1: カテゴリ平均より高い地価エリア
- 比率 < 1: カテゴリ平均より低い地価エリア

| カテゴリカラム | ユニーク数 | 出力 | 説明 |
|----------------|------------|------|------|
| post1 | ~900 | `lp_ratio_post1` | 郵便番号上3桁別 |
| post_full | ~8,000 | `lp_ratio_post_full` | 郵便番号7桁別 |
| addr1_1 | 47 | `lp_ratio_addr1_1` | 都道府県別 |
| addr1_2 | 126 | `lp_ratio_addr1_2` | 市区町村別 |
| bukken_type | 2 | `lp_ratio_bukken_type` | 物件タイプ別 |
| land_youto | 15 | `lp_ratio_land_youto` | 用途地域別 |
| land_toshi | 6 | `lp_ratio_land_toshi` | 都市計画別 |
| building_age_bin | 11 | `lp_ratio_building_age_bin` | 築年数カテゴリ別 |
| rosen_name1 | 508 | `lp_ratio_rosen_name1` | 路線名別 |

**出力**: 9カテゴリ × 2（平均 + 比率） = **18次元**

| 出力カラム | 説明 |
|------------|------|
| `{col}_lp_mean` | カテゴリ別の地価平均 |
| `{col}_lp_ratio` | lp_price / カテゴリ別平均 |

**補完**: 未知のカテゴリはグローバル平均で補完

---

## 特徴量サマリー

| カテゴリ | 処理 | 出力次元 |
|----------|------|----------|
| 土地属性 | PCA | 1 |
| 道路状況 | SVD(13) + 数値(1) | 14 |
| 周辺環境 | ラベルエンコ | 1 |
| 都市計画 | 除外 | 0 |
| 価格 | そのまま | 3 |
| 価格時系列 | 比率計算 | 2 |
| カテゴリ別地価比率 | 平均 + 比率 | 18 |
| **合計** | | **39** |

- exp008: 181個
- **exp009**: 181 + 39 = **220個**

---

## 次回実験に回す項目

| 項目 | 理由 |
|------|------|
| 周辺土地利用（Embedding） | テキスト処理が複雑 |
| 組み合わせ特徴量（地価×面積等） | 追加検証が必要 |
| 都市計画（防火地域） | 優先度低 |

---

## 除外するカラム（train/testに存在）

| 地価公示カラム | train/testカラム | 理由 |
|----------------|------------------|------|
| 建物構造 | building_structure | 重複 |
| 地上階層 | floor_count | 重複 |
| 地下階層 | basement_floor_count | 重複 |
| 駅距離 | walk_distance1 | 類似 |
| 都市計画用途地域 | land_youto | 重複 |
| 都市計画区分 | land_toshi | 重複 |
| 建蔽率 | land_kenpei | 重複 |
| 容積率 | land_youseki | 重複 |

---

## 実装詳細

### 座標変換

```python
# 地価公示: 秒 → 度
landprice['lon_wgs'] = landprice['経度'] / 3600
landprice['lat_wgs'] = landprice['緯度'] / 3600
```

### 年度別価格カラム名

| 年度 | 当年 | 1年前 | 3年前 | 5年前 |
|------|------|-------|-------|-------|
| 2019 | `Ｈ３１価格` | `Ｈ３０価格` | `Ｈ２８価格` | `Ｈ２６価格` |
| 2020 | `Ｒ２価格` | `Ｈ３１価格` | `Ｈ２９価格` | `Ｈ２７価格` |
| 2021 | `Ｒ３価格` | `Ｒ２価格` | `Ｈ３０価格` | `Ｈ２８価格` |
| 2022 | `Ｒ４価格` | `Ｒ３価格` | `Ｈ３１価格` | `Ｈ２９価格` |
| 2024 | `価格R06` | `価格R05` | `価格R03` | `価格R01` |

### 価格時系列の計算（スライド方式）

```python
# 例: 2024年データの場合
lp_ratio_1to3 = price_R05 / price_R03  # 1年前 / 3年前
lp_ratio_3to5 = price_R03 / price_R01  # 3年前 / 5年前
```

---

## ファイル構成

```
exp009_landprice/
├── README.md              # この仕様書
├── code/
│   ├── load_landprice.py  # 地価公示データ読み込み
│   ├── join_landprice.py  # 最近傍結合処理
│   ├── preprocessing.py   # 前処理コード
│   └── train.py          # 学習スクリプト
├── configs/
│   └── params.yaml       # パラメータ設定
├── outputs/              # 出力ファイル
└── notebooks/            # 分析用ノートブック
```

---

## 実験履歴

| 実験 | CV MAPE | 特徴量数 | 備考 |
|------|---------|----------|------|
| exp005 | 14.74% | 88 | ベースライン |
| exp006 | 14.19% | 119 | +路線・駅・アクセス時間 |
| exp007 | 13.62% | 164 | +タグSVD |
| exp008 | 13.44% | 181 | +リフォーム・郵便番号TE・面積比率 |
| **exp009** | **TBD** | **220** | +地価公示（39次元） |

---

## 結果サマリー

**注**: 地価公示データの年度マッピングを修正（test: 2024年→2023年）して再実験中。

---

## 今後の検討事項

### LightGBMパラメータチューニング

現状 `n_estimators=50000` でもEarly Stoppingが発動しない（収束しない）。

#### 案1: 学習率を上げる（推奨）

```yaml
learning_rate: 0.05      # 0.03 → 0.05
n_estimators: 30000      # 50000 → 30000
max_depth: 6             # 5 → 6
num_leaves: 31           # 20 → 31
min_child_samples: 50    # 100 → 50
early_stopping_rounds: 200
```

**メリット**: 学習時間短縮、Early Stoppingが効きやすい

#### 案2: イテレーションを増やす

```yaml
learning_rate: 0.03      # そのまま
n_estimators: 100000     # 50000 → 100000
early_stopping_rounds: 300
```

**メリット**: 低学習率で精度が出る可能性
**デメリット**: 学習時間が長い

### 目標スコア参考値

| 目標MAPE | 必要なRMSE | 必要なl2 (MSE) |
|----------|------------|----------------|
| 14% | ≈ 0.21 | ≈ 0.044 |
| 13% | ≈ 0.19 | ≈ 0.036 |
| 12% | ≈ 0.18 | ≈ 0.032 |
| 11% | ≈ 0.16 | ≈ 0.026 |
