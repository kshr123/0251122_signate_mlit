# =============================================================================
# 003_regressor_lowprice - 低価格専用回帰モデル
# =============================================================================

meta:
  name: "低価格専用回帰モデル"
  description: |
    分類器で「低価格」と判定されたサンプルに特化した回帰モデル。
    - 学習データ: 低価格サンプルのみ（下位20%ile）
    - 目的: 低価格帯での過大予測（overpredict）を削減
    - ターゲット: log(price) を使用
  parent: "001_classifier_baseline"
  created_at: "2024-12-04"

experiment:
  id: "exp019"
  name: "exp019_regressor_lowprice"
  description: "2段階予測 - Stage2a: 低価格専用回帰器"

# -----------------------------------------------------------------------------
# 学習設定
# -----------------------------------------------------------------------------
training:
  seed: 42

  # CV設定（KFold - 回帰タスク）
  cv:
    strategy: "kfold"
    kfold:
      n_splits: 5  # 低価格: 5fold（データ少ないのでfold多め）
      shuffle: true
      random_state: 42

  # ターゲット変換
  target:
    transform: "log1p"  # log(1 + y) 変換
    inverse: "expm1"    # 予測時に逆変換

  # データフィルタリング（低価格のみ）
  data_filter:
    use_true_label: true  # 年度別閾値で低価格判定（constants.YEAR_PRICE_THRESHOLDSを使用）

# -----------------------------------------------------------------------------
# モデル設定（LightGBM Regressor）
# -----------------------------------------------------------------------------
model:
  type: "lgbm"

  # 本番パラメータ
  params:
    objective: "regression"
    metric: "l2"
    boosting_type: "gbdt"

    # 学習率・木の構造
    learning_rate: 0.03
    num_leaves: 63
    max_depth: 10

    # 正則化（過学習抑制 - サンプル数が少ないため強め）
    min_child_samples: 100
    min_child_weight: 10.0
    reg_alpha: 1.0
    reg_lambda: 1.0
    feature_fraction: 0.8
    bagging_fraction: 0.8
    bagging_freq: 1

    # 学習設定
    n_estimators: 10000
    early_stopping_rounds: 200

    # その他
    verbose: -1
    n_jobs: -1

  # テスト用パラメータ（高速化）
  params_test:
    objective: "regression"
    metric: "l2"
    boosting_type: "gbdt"
    learning_rate: 0.1
    num_leaves: 31
    max_depth: 6
    min_child_samples: 20
    n_estimators: 100
    early_stopping_rounds: 10
    verbose: -1
    n_jobs: -1

# -----------------------------------------------------------------------------
# 特徴量設定
# -----------------------------------------------------------------------------
features:
  # TF-IDF
  tfidf:
    max_features: 20

  # 地理情報PCA
  geo_pca:
    n_components: 2

  # タグSVD
  building_tag_svd:
    n_components: 15
  unit_tag_svd:
    n_components: 30
  statuses_svd:
    n_components: 30
  reform_svd:
    n_components: 7

  # 地価公示
  landprice:
    road_svd_dim: 13

  # ビニング
  binning:
    density_bin:
      percentiles: [10, 30, 70]

# -----------------------------------------------------------------------------
# 評価設定
# -----------------------------------------------------------------------------
evaluation:
  primary_metric: "l2"
  secondary_metrics:
    - "rmse"
    - "mae"
    - "median_ae"
  # 価格帯別評価（低価格帯での精度を重視）
  segment_evaluation:
    enabled: true
    segments:
      - name: "bottom_20"
        quantile: 0.2
        weight: 2.0  # 評価時の重み

# -----------------------------------------------------------------------------
# チューニング設定
# -----------------------------------------------------------------------------
tuning:
  n_trials: 100
  timeout: 14400  # 4時間
  n_cv_splits: 3  # チューニング用は3fold（高速化）

  param_space:
    learning_rate:
      type: float
      low: 0.01
      high: 0.1
      log: true
    num_leaves:
      type: int
      low: 15
      high: 127
    max_depth:
      type: int
      low: 6
      high: 14
    min_child_samples:
      type: int
      low: 20
      high: 200
    min_child_weight:
      type: float
      low: 1.0
      high: 50.0
      log: true
    reg_alpha:
      type: float
      low: 0.01
      high: 10.0
      log: true
    reg_lambda:
      type: float
      low: 0.01
      high: 10.0
      log: true
    feature_fraction:
      type: float
      low: 0.5
      high: 1.0
    bagging_fraction:
      type: float
      low: 0.5
      high: 1.0
    bagging_freq:
      type: int
      low: 1
      high: 7

# -----------------------------------------------------------------------------
# 出力設定
# -----------------------------------------------------------------------------
output:
  save_model: true
  save_predictions: true
  save_feature_importance: true
