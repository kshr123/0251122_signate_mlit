# 地価公示データ結合戦略

## 概要

train/testデータと地価公示データ（2024, 2025年）を結合し、特徴量として活用する戦略を定義する。

---

## 1. 結合キーの分析

### 1.1 都道府県コードの対応
- **train/test**: `addr1_1` (1〜47の整数)
- **地価公示**: `行政区域コード` (5桁: 都道府県2桁 + 市区町村3桁)
- **対応**: 全47都道府県が両データに存在 ✅

### 1.2 座標系の違い
| データ | 座標系 | 経度 | 緯度 |
|--------|--------|------|------|
| train/test | WGS84（度） | `lon` 127.6〜144.4 | `lat` 26.1〜43.9 |
| 地価公示 | JGD2011（秒） | `経度` 446,937〜524,162 | `緯度` 87,613〜163,519 |

> **重要**: 地価公示データの座標は**秒**単位。`度 = 秒 / 3600` で変換。

### 1.3 データ量
| 都道府県 | train件数 | 地価公示件数 |
|----------|-----------|-------------|
| 13（東京） | 66,434 | 2,560 |
| 27（大阪） | 44,752 | 1,687 |
| 14（神奈川） | 42,228 | 1,758 |
| 11（埼玉） | 30,930 | 1,280 |
| 12（千葉） | 23,926 | 1,238 |

---

## 2. 結合の基本概念

### なぜ完全一致ではないか

| データ | 件数 | 内容 |
|--------|------|------|
| train | 363,924件 | 個別の不動産物件 |
| 地価公示 | 約25,500件/年 | 国が選定した調査地点 |

物件の座標と地価公示地点が**ピッタリ一致することはほぼない**ため、**最近傍探索**で結合する。

### 結合の流れ

```
物件A (lon=139.77, lat=35.68)
    ↓ 最近傍探索（BallTree）
地価公示で最も近い地点を見つける
    ↓
その地点の地価・属性を特徴量として付与
```

### 距離の目安

- 地価公示は約25,500地点 → 平均**数km間隔**で分布
- 都市部は密、地方は疎
- 最近傍が**5km以上**離れている場合は欠損扱いを検討

---

## 3. 結合戦略

### 戦略A: 座標ベース最近傍結合（推奨）

各train/testレコードに対し、最も近い地価公示地点を特定して結合。

#### 実装手順
1. 地価公示の座標を秒からWGS84（度）に変換: `度 = 秒 / 3600`
2. BallTreeまたはKDTreeで空間インデックスを構築
3. 各train/testレコードから最近傍のN件を取得
4. 距離加重平均や統計量を計算

#### コード例
```python
import numpy as np
from sklearn.neighbors import BallTree

# 地価公示データの座標を秒からWGS84（度）に変換
landprice['lon_wgs'] = landprice['経度'] / 3600
landprice['lat_wgs'] = landprice['緯度'] / 3600
landprice_coords = np.radians(landprice[['lat_wgs', 'lon_wgs']].values)

# BallTreeを構築（Haversine距離）
tree = BallTree(landprice_coords, metric='haversine')

# trainの座標
train_coords = np.radians(train[['lat', 'lon']].values)

# 最近傍3件を取得
distances, indices = tree.query(train_coords, k=3)

# 距離をkmに変換（地球半径 6371km）
distances_km = distances * 6371
```

#### 生成する特徴量
| 特徴量名 | 説明 |
|----------|------|
| `landprice_nearest` | 最近傍地点の公示価格 |
| `landprice_nearest_dist` | 最近傍地点までの距離（km） |
| `landprice_avg_3` | 最近傍3件の平均価格 |
| `landprice_avg_5` | 最近傍5件の平均価格 |
| `landprice_change_rate` | 最近傍地点の対前年変動率 |

---

### 戦略B: 行政区域ベース集計結合

市区町村単位で地価公示を集計し、trainの住所情報と結合。

#### 実装手順
1. 地価公示を行政区域コード別に集計
2. trainの都道府県・市区町村情報と結合

#### コード例
```python
# 行政区域コードの先頭2桁（都道府県）で集計
landprice['pref_code'] = landprice['行政区域コード'] // 1000

# 都道府県別集計
pref_stats = landprice.groupby('pref_code').agg({
    '価格R07': ['mean', 'median', 'std', 'min', 'max', 'count'],
    '対前年変動率': ['mean', 'median']
}).reset_index()

# trainと結合
train = train.merge(pref_stats, left_on='addr1_1', right_on='pref_code', how='left')
```

#### 生成する特徴量
| 特徴量名 | 説明 |
|----------|------|
| `landprice_pref_mean` | 都道府県の平均地価 |
| `landprice_pref_median` | 都道府県の中央値地価 |
| `landprice_pref_std` | 都道府県の地価標準偏差 |
| `landprice_pref_change` | 都道府県の平均変動率 |

---

### 戦略C: 半径ベース集計結合

指定半径内の地価公示地点を集計。

#### 実装手順
1. 座標変換（戦略Aと同様）
2. 各train/testレコードから半径Xkm以内の地点を抽出
3. 統計量を計算

#### コード例
```python
# 半径1km以内の地点を取得
radius_km = 1.0
radius_rad = radius_km / 6371  # ラジアンに変換

indices = tree.query_radius(train_coords, r=radius_rad)

# 各レコードについて統計量を計算
for i, idx_list in enumerate(indices):
    if len(idx_list) > 0:
        prices = landprice.iloc[idx_list]['価格R07']
        train.loc[i, 'landprice_1km_mean'] = prices.mean()
        train.loc[i, 'landprice_1km_count'] = len(idx_list)
```

---

## 3. 座標変換の詳細

### JGD2011（秒）→ WGS84（度）変換

地価公示データの座標は**JGD2011（世界測地系）**で、単位は**秒**。
WGS84への変換は単純な除算のみ。

```python
def convert_seconds_to_degrees(seconds: float) -> float:
    """秒単位の座標を度単位に変換"""
    return seconds / 3600

# 使用例
landprice['lon_wgs'] = landprice['経度'] / 3600  # 例: 501376.613 → 139.2713
landprice['lat_wgs'] = landprice['緯度'] / 3600  # 例: 154999.616 → 43.0554
```

### 変換の検証
```python
# 東京駅付近の地価公示地点の例
lon_sec = 502552.0  # 秒
lat_sec = 128410.0  # 秒

lon_deg = lon_sec / 3600  # → 139.598°
lat_deg = lat_sec / 3600  # → 35.669°
# → 東京駅付近（139.77°, 35.68°）に近い値になる
```

---

## 4. 推奨実装順序

### Phase 1: 行政区域ベース（簡易）
1. 都道府県単位の地価統計を計算
2. trainと結合して効果検証
3. 実装工数: 小、効果: 中

### Phase 2: 座標ベース最近傍（本格）
1. 座標変換の実装
2. BallTreeによる最近傍探索
3. 距離・件数ベースの特徴量生成
4. 実装工数: 中、効果: 大

### Phase 3: 半径ベース集計（拡張）
1. 複数半径（500m, 1km, 3km）での集計
2. 用途地域別の集計
3. 実装工数: 中、効果: 中〜大

---

## 5. 活用カラム一覧（2024/2025年）

### 価格関連
| カラム名 | 2024 | 2025 | 説明 |
|----------|------|------|------|
| 公示価格 | `価格R06` | `価格R07` | 円/㎡ |
| 対前年変動率 | `対前年変動率` | `対前年変動率` | % |

### 立地属性
| カラム名 | 説明 | 特徴量化案 |
|----------|------|-----------|
| 前面道路幅員 | 道路幅（m） | 数値そのまま |
| 前面道路区分 | 道路種別 | カテゴリエンコーディング |
| 駅距離 | 最寄駅距離（m） | 数値そのまま |
| 利用現況 | 土地利用状況 | カテゴリエンコーディング |

### 都市計画属性
| カラム名 | 説明 | 特徴量化案 |
|----------|------|-----------|
| 防火地域 | 防火指定 | カテゴリエンコーディング |
| 高度地区 | 高度制限 | カテゴリエンコーディング |
| 建蔽率 | 建蔽率（%） | 数値そのまま |
| 容積率 | 容積率（%） | 数値そのまま |

---

## 6. train/testデータとの対応関係

### 6.1 結合キー候補

| 結合キー | train/test | 地価公示 | 対応方法 |
|----------|------------|----------|----------|
| **座標（推奨）** | `lon`, `lat` (WGS84度) | `経度`, `緯度` (秒) | 秒→度変換後、最近傍探索 |
| **都道府県** | `addr1_1` (JISコード1-47) | `行政区域コード` (先頭2桁) | コード変換 |
| **市区町村** | `addr1_2` (JISコード) | `行政区域コード` (5桁) | コード結合 |

### 6.2 類似カラム（地価公示で補完可能）

| train/test | 地価公示 | 補完の可能性 |
|------------|----------|-------------|
| `building_structure` (建物構造: 1-13) | `建物構造` (SRC, RC, S, W等) | コード体系異なる、参考値 |
| `land_youto` (用途地域: 1-14,99) | `都市計画用途地域` | 類似分類、マッピング可能 |
| `land_toshi` (都市計画: 1-4) | `都市計画区分` | 類似分類 |
| `land_kenpei` (建ぺい率: %) | `建蔽率` (%) | 同じ意味、補完可能 |
| `land_youseki` (容積率: %) | `容積率` (%) | 同じ意味、補完可能 |
| `floor_count` (地上階数) | `地上階層` | 同じ意味 |
| `basement_floor_count` (地下階数) | `地下階層` | 同じ意味 |
| `walk_distance1` (徒歩距離: m) | `駅距離` (m) | 同じ意味 |

### 6.3 地価公示のみのカラム（新規特徴量候補）

| カラム名 | 説明 | 特徴量としての活用 |
|----------|------|-------------------|
| **価格R06/R07** | 公示地価（円/㎡） | 近隣の土地相場 |
| **対前年変動率** | 地価変動率（%） | エリアの成長性 |
| **前面道路幅員** | 道路幅（m） | 立地条件 |
| **前面道路区分** | 道路種別 | 交通利便性 |
| **前面道路方位** | 道路の向き | 日照条件の参考 |
| **利用現況** | 住宅、店舗等 | 周辺環境 |
| **防火地域** | 防火、準防火 | 建築制限 |
| **高度地区** | 高度制限 | 建築制限 |
| **地積** | 土地面積（㎡） | 参考値 |
| **土地形状** | 台形、不整形等 | 土地条件 |

### 6.4 座標系の詳細

| データ | カラム | 座標系 | 単位 | 変換 |
|--------|--------|--------|------|------|
| train/test | `lon`, `lat` | WGS84（世界測地系） | 度 | 不要 |
| train/test | `el`, `nl` | 日本測地系 | ミリ秒 | 度 = ミリ秒 / 3,600,000 |
| 地価公示 | `経度`, `緯度` | JGD2011（世界測地系） | 秒 | 度 = 秒 / 3,600 |

> **注意**: train/testの`lon`, `lat`と地価公示の変換後座標は同じWGS84系なので直接比較可能。

---

## 7. 実装時の注意事項

1. **座標変換**: 地価公示は秒単位、`度 = 秒 / 3600`で変換
2. **欠損値処理**: 最近傍が遠すぎる場合（例: 5km以上）はNaNまたはフォールバック
3. **時系列の整合性**: train/testの`target_ym`と地価公示の年度を合わせる
   - target_ym 202301〜202312 → 2023年（R05）または2024年（R06）データ
   - target_ym 202401〜202412 → 2024年（R06）または2025年（R07）データ
4. **メモリ効率**: 大規模データの場合はバッチ処理を検討
5. **カラム名の違い**: 2022-2023年は全角（Ｒ４価格）、2024-2025年は半角（価格R06）

---

## 更新履歴
- 2025-11-26: 初版作成
- 2025-11-26: train/testデータ定義との対応関係を追加
