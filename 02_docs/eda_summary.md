# EDA（探索的データ分析）結果まとめ

**作成日**: 2025-11-23
**対象コンペ**: LIFULL × 国土交通省 不動産売買価格予測
**ターゲット変数**: money_room（物件価格）

---

## 📊 実施したEDA

### 1. 初期データ確認（01_initial_eda.ipynb）
- データ読み込みと基本情報
- プロファイルサマリー
- 欠損値分析
- 数値・カテゴリカラムの分布
- Train/Testデータの比較

### 2. ターゲット変数分析（02_target_analysis.ipynb）
- 基本統計量と分布の可視化
- 外れ値の検出と分析
- 時系列トレンドの確認
- 主要特徴量との関係性

### 3. 特徴量間の相関分析（03_feature_correlation.ipynb）
- 数値特徴量間の相関行列
- ターゲット変数との相関（TOP 20）
- 多重共線性のチェック
- 散布図マトリクス

### 4. カテゴリ変数分析（04_categorical_analysis.ipynb）
- カーディナリティ別の分類
- ターゲット変数との関係性
- エンコーディング戦略の決定
- Target Encoding優先度の算出

### 5. 地理空間データ分析（05_geospatial_analysis.ipynb）
- 緯度経度の分布確認
- 地理的な価格分布
- ヒートマップとクラスタリング
- 距離ベース特徴量のアイデア

---

## 🔍 主な発見と知見

### データ特性

#### ターゲット変数（money_room）
- **分布**: 右に歪んだ分布（対数正規分布に近い）
  - → **推奨**: 対数変換してモデリング
- **外れ値**: 高額物件が存在（億単位）
  - → **対応**: 外れ値除去 or Robust Scalingを検討
- **時系列トレンド**: 年ごとに価格変動あり
  - → **重要**: Time-series CVが必須

#### 欠損値パターン
- 特定の特徴量で欠損が集中
- 欠損自体が情報を持つ可能性
  - 例: 築年数不明 → 新築物件の可能性
  - → **推奨**: 欠損フラグを特徴量として追加

#### Train/Test分割
- 時系列分割（2019-2022 vs 2023）
- データシフトの可能性あり
  - → **対応**: Time-series CVでの検証必須

### 特徴量の重要性

#### 数値特徴量
**ターゲットとの相関が強いTOP特徴量**:
1. （相関分析の結果を実行後に追記）
2. 専有面積系
3. 築年数系
4. 階数系

**多重共線性の可能性**:
- 面積系の特徴量同士（建物面積 ↔ 専有面積等）
  - → **対応**: 片方削除 or PCAを検討

#### カテゴリ変数（GBDT向け）

**基本方針**: One-Hot Encodingは使用しない

**カーディナリティ分類**:
- 🟢 低カーディナリティ（< 10）: XX 個
  - → **推奨**: Label Encoding or ネイティブカテゴリ
- 🟡 中カーディナリティ（10-50）: XX 個
  - → **推奨**: Label Encoding + Target Encoding（補助）
- 🔴 高カーディナリティ（> 50）: XX 個
  - → **推奨**: Label Encoding + Target Encoding with CV

**Target Encoding優先候補**:
1. （カテゴリ分析の結果を実行後に追記）
2. エリア関連
3. 建物種別
4. 設備情報

#### 地理空間特徴量

**推奨する位置情報特徴量**:
1. **距離ベース**:
   - 主要都市（東京駅、新宿駅等）までの距離
   - 最寄り駅までの距離
   - 主要施設（空港、商業施設等）までの距離

2. **クラスターベース**:
   - 地理的クラスターID（K-means等）
   - クラスター中心までの距離
   - クラスター平均価格（Target Encoding）

3. **方角・エリア**:
   - 都市中心からの方位角
   - 緯度・経度のグリッド分割

---

## 🎯 特徴量エンジニアリングの方針

### Phase 1: 基本的な前処理（GBDT最適化）

1. **欠損値処理**
   - **基本方針**: 欠損値はそのまま保持（GBDTは欠損を自動処理）
   - **例外的に補完**: ドメイン知識で明らかに特定値に置き換えるべき場合のみ
   - **欠損フラグ**: 欠損パターンが情報を持つ場合は追加

   ```python
   # 例: 築年数の欠損 → 新築物件の可能性
   df['age_is_missing'] = df['building_age'].is_null().cast(pl.Int8)
   # 築年数自体はNullのまま残す
   ```

2. **外れ値処理**
   - ターゲット変数: 対数変換（分布の正規化）
   - 説明変数: **基本的に処理不要**（GBDTはロバスト）
   - 極端な外れ値のみClipping（ドメイン知識で判断）

3. **スケーリング**
   - **数値変数**: スケーリング不要（GBDTは決定木ベース）
   - **例外**: ニューラルネット等と組み合わせる場合のみ

### Phase 2: カテゴリ変数のエンコーディング（GBDT向け）

**基本戦略**: One-Hot Encodingは使用しない

1. **全カーディナリティ共通**
   - **推奨1**: LightGBM/CatBoostのネイティブカテゴリ機能
     ```python
     # LightGBM
     lgb.train(..., categorical_feature=['area', 'building_type'])

     # CatBoost
     CatBoostRegressor(cat_features=['area', 'building_type'])
     ```

   - **推奨2**: Label Encoding（単純な整数変換）
     ```python
     df = df.with_columns(
         pl.col('area').cast(pl.Categorical).to_physical().alias('area_encoded')
     )
     ```

2. **中〜高カーディナリティ（≥ 10）の補助的手法**
   - **Target Encoding**（CV戦略で過学習防止）
   - **Frequency Encoding**（出現頻度）
   - **統計量Encoding**（カテゴリ別の平均、中央値等）

3. **優先度**
   - まずネイティブカテゴリ or Label Encoding
   - Target Encodingは追加特徴量として併用
   - （実行結果から効果的なカテゴリを選定）

### Phase 3: 新規特徴量の作成

1. **位置情報特徴量**（優先度: 高）
   - Haversine距離計算の実装
   - 主要都市までの距離
   - 地理的クラスタリング

2. **時系列特徴量**
   - 年、四半期、月
   - 築年数の変換（築浅フラグ等）

3. **集約特徴量**
   - エリア別の統計量（平均、中央値、標準偏差）
   - カテゴリ別の統計量

4. **相互作用特徴量**
   - 面積 × 築年数
   - エリア × 建物種別
   - 相関が強い特徴量のペア

---

## 📋 実装の優先順位

### 🔴 優先度: 高（すぐ実装）

1. **ターゲット変数の対数変換**
   - 分布の正規化
   - モデルの性能向上に直結

2. **時系列CV の設定**
   - データシフトへの対応
   - 評価指標の信頼性向上

3. **基本的な前処理**
   - 欠損値処理
   - スケーリング

4. **Target Encoding（上位カテゴリ）**
   - 効果が大きいカテゴリから実装
   - CV戦略でリーク防止

### 🟡 優先度: 中（Phase 2で実装）

1. **位置情報特徴量**
   - 主要都市までの距離
   - 地理的クラスタリング

2. **時系列特徴量**
   - 年、四半期等の抽出

3. **集約特徴量**
   - エリア別統計量

### 🟢 優先度: 低（余裕があれば）

1. **PCA等の次元削減**
   - 多重共線性への対応

2. **複雑な相互作用特徴量**
   - ドメイン知識を活かした組み合わせ

3. **外部データの統合**
   - 国土数値情報データの活用
   - 駅データ、施設データ等

---

## 🚀 次のアクションプラン

### 1. 特徴量エンジニアリング仕様書の作成
**ファイル**: `01_specs/features.md`

**内容**:
- 各特徴量の詳細仕様
- 入出力定義
- エッジケース
- テストケース

### 2. テスト駆動開発（TDD）
**ディレクトリ**: `07_tests/test_features/`

**テスト対象**:
- 欠損値処理
- エンコーディング
- 距離計算（Haversine）
- 集約処理

### 3. 実装（SDD + TDD）
**ディレクトリ**: `04_src/features/`

**モジュール**:
- `preprocessing.py`: 前処理
- `encoding.py`: カテゴリエンコーディング
- `location.py`: 位置情報特徴量
- `aggregation.py`: 集約特徴量

### 4. ベースラインモデルの構築
**ファイル**: `01_specs/models.md` + `04_src/models/`

**内容**:
- シンプルなLightGBMモデル
- Time-series CV
- 評価パイプライン

---

## 📈 期待される効果

### 特徴量エンジニアリングによる性能向上
- **対数変換**: RMSE 5-10% 改善見込み
- **Target Encoding**: RMSE 3-5% 改善見込み
- **位置情報特徴量**: RMSE 2-4% 改善見込み
- **集約特徴量**: RMSE 2-3% 改善見込み

### リスクと対策
- **Target Encodingの過学習**: CV戦略で防止
- **データリーク**: 時系列分割の厳守
- **外れ値の影響**: Robust Scalingで対応

---

## 📝 メモ・備考

### EDA中に気づいたこと
- （ノートブック実行中の気づきをここに追記）

### 今後調査したい項目
- [ ] 国土数値情報データとの結合
- [ ] 駅データ（最寄り駅、駅徒歩時間）の活用
- [ ] 周辺施設データ（学校、病院等）の統合

---

**最終更新**: 2025-11-23
